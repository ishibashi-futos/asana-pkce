<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Asana OAuth PKCE Demo</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        #user-info { margin-top: 20px; font-weight: bold; font-size: 1.2em; color: #f06292; }
        button { padding: 10px 20px; cursor: pointer; background: #20a0ff; color: white; border: none; border-radius: 4px; }
    </style>
</head>
<body>

    <h1>Asana OAuth PKCE</h1>
    <button id="login-btn">Asanaでログイン</button>
    <div id="user-info"></div>

    <script>
        const CLIENT_ID = '1212462676621769'; // あなたのClient IDに書き換えてください
        const REDIRECT_URI = 'https://ishibashi-futos.github.io/asana-pkce/';

      // --- 1. PKCE用のヘルパー関数 ---
        const generateRandomString = (length) => {
            const array = new Uint32Array(length / 2);
            crypto.getRandomValues(array);
            return Array.from(array, dec => ('0' + dec.toString(16)).substr(-2)).join('');
        };

        const sha256 = async (plain) => {
            const encoder = new TextEncoder();
            const data = encoder.encode(plain);
            return crypto.subtle.digest('SHA-256', data);
        };

        const base64urlencode = (a) => {
            return btoa(String.fromCharCode.apply(null, new Uint8Array(a)))
                .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        };

        // --- 2. 認可リクエスト (ログインボタン) ---
        document.getElementById('login-btn').addEventListener('click', async () => {
            const codeVerifier = generateRandomString(64);
            localStorage.setItem('pkce_code_verifier', codeVerifier); // 交換時に使うため保存

            const hashed = await sha256(codeVerifier);
            const codeChallenge = base64urlencode(hashed);

            const authUrl = `https://app.asana.com/-/oauth_authorize?` +
                `response_type=code&` +
                `client_id=${CLIENT_ID}&` +
                `redirect_uri=${encodeURIComponent(REDIRECT_URI)}&` +
                `code_challenge=${codeChallenge}&` +
                `code_challenge_method=S256&` +
                `scope=openid%20profile%20email&` +
                `state=${generateRandomString(16)}`;

            window.location.href = authUrl; // Asanaへリダイレクト
        });

        // --- 3. コールバック処理 (トークン交換とデータ取得) ---
        window.onload = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');

            if (code) {
                // URLからcodeを消す（見た目のため）
                window.history.replaceState({}, document.title, window.location.pathname);
                
                const codeVerifier = localStorage.getItem('pkce_code_verifier');

                try {
                    // トークン交換リクエスト
                    const response = await fetch('https://app.asana.com/-/oauth_token', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams({
                            grant_type: 'authorization_code',
                            client_id: CLIENT_ID,
                            redirect_uri: REDIRECT_URI,
                            code: code,
                            code_verifier: codeVerifier
                        })
                    });

                    const data = await response.json();
                    const accessToken = data.access_token;

                    // --- ユーザー情報の取得 (エンドポイントを修正) ---
                    const userRes = await fetch('https://app.asana.com/api/1.0/openid_connect/userinfo', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    const userData = await userRes.json();
                    // デバッグ用に中身をコンソールに出力
                    document.getElementById('user-info').innerText = `こんにちは、${JSON.stringify(userData)} さん！`;

                    // OIDCレスポンスでは userData.name に直接名前が入っています
//                    document.getElementById('user-info').innerText = `こんにちは、${userData.name} さん！`;
                    document.getElementById('login-btn').style.display = 'none';

                } catch (error) {
                    console.error('認証に失敗しました', error);
                }
            }
        };
    </script>
</body>
</html>
